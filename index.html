<!DOCTYPE html>
<html>
<head>
    <title>Box Rain Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.18.0/matter.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            cursor: crosshair;
        }
        
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #background {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }

        #game-canvas {
            position: absolute;
            z-index: 2;
        }

        #particles-canvas {
            position: absolute;
            z-index: 3;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <img id="background" src="wall1.jpg" alt="Background">
        <canvas id="game-canvas"></canvas>
        <canvas id="particles-canvas"></canvas>
    </div>

    <script>
        const Engine = Matter.Engine,
            Render = Matter.Render,
            World = Matter.World,
            Bodies = Matter.Bodies,
            Events = Matter.Events;

        const CONFIG = {
            GAME_WIDTH: 1920,
            GAME_HEIGHT: 1080,
            PLATFORM: {
                WIDTH: 1337,
                HEIGHT: 216,
                Y_POS: 1080 - 216
            },
            BOX: {
                SIZE: 117,
                SPAWN_OFFSET: -50,
                PHYSICS: {
                    density: 0.8,
                    friction: 0.5,
                    restitution: 0.3
                }
            },
            PARTICLES: {
                MAX: 500, // Максимум частиц
                SIZE: 4,
                LIFE: 30,
                SPEED: 3,
                COUNT: 3 // Частиц за удар
            }
        };

        const engine = Engine.create();
        const render = Render.create({
            element: document.getElementById('game-container'),
            engine: engine,
            canvas: document.getElementById('game-canvas'),
            options: {
                width: CONFIG.GAME_WIDTH,
                height: CONFIG.GAME_HEIGHT,
                wireframes: false,
                background: 'transparent'
            }
        });

        // Система частиц
        const particlesCanvas = document.getElementById('particles-canvas');
        const pctx = particlesCanvas.getContext('2d');
        particlesCanvas.width = CONFIG.GAME_WIDTH;
        particlesCanvas.height = CONFIG.GAME_HEIGHT;
        
        let particles = [];
        
        class Particle {
            constructor(x, y, color) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * CONFIG.PARTICLES.SPEED;
                this.vy = (Math.random() - 0.5) * CONFIG.PARTICLES.SPEED;
                this.life = CONFIG.PARTICLES.LIFE;
                this.color = color;
            }
            
            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += 0.1;
                this.life--;
            }
            
            draw() {
                pctx.fillStyle = this.color;
                pctx.beginPath();
                pctx.arc(this.x, this.y, CONFIG.PARTICLES.SIZE, 0, Math.PI * 2);
                pctx.fill();
            }
        }

        function createParticles(x, y, color) {
            if(particles.length > CONFIG.PARTICLES.MAX) return;
            
            for(let i = 0; i < CONFIG.PARTICLES.COUNT; i++) {
                particles.push(new Particle(x, y, color));
            }
        }

        function updateParticles() {
            pctx.clearRect(0, 0, particlesCanvas.width, particlesCanvas.height);
            
            for(let i = particles.length - 1; i >= 0; i--) {
                particles[i].update();
                particles[i].draw();
                
                if(particles[i].life <= 0) {
                    particles.splice(i, 1);
                }
            }
            
            requestAnimationFrame(updateParticles);
        }

        // Обработчик столкновений
        Events.on(engine, 'collisionStart', (event) => {
            event.pairs.forEach((pair) => {
                const color = pair.bodyA.label === 'platform' || 
                            pair.bodyB.label === 'platform' ? 
                            '#FFD700' : '#FF4500';
                
                createParticles(
                    pair.collision.supports[0].x,
                    pair.collision.supports[0].y,
                    color
                );
            });
        });

        // Платформа
        const platform = Bodies.rectangle(
            CONFIG.GAME_WIDTH / 2,
            CONFIG.PLATFORM.Y_POS - CONFIG.PLATFORM.HEIGHT/2,
            CONFIG.PLATFORM.WIDTH,
            CONFIG.PLATFORM.HEIGHT,
            {
                isStatic: true,
                label: 'platform',
                render: {
                    sprite: {
                        texture: 'R1.jpg',
                        xScale: 1,
                        yScale: 1
                    }
                }
            }
        );

        // Границы
        const boundaries = [
            Bodies.rectangle(-50, CONFIG.GAME_HEIGHT/2, 100, CONFIG.GAME_HEIGHT, { 
                isStatic: true, 
                render: { visible: false } 
            }),
            Bodies.rectangle(CONFIG.GAME_WIDTH + 50, CONFIG.GAME_HEIGHT/2, 100, CONFIG.GAME_HEIGHT, { 
                isStatic: true, 
                render: { visible: false } 
            })
        ];

        World.add(engine.world, [platform, ...boundaries]);

        // Обработка кликов
        document.addEventListener('click', (e) => {
            const rect = render.canvas.getBoundingClientRect();
            const scaleX = CONFIG.GAME_WIDTH / rect.width;
            
            const box = Bodies.rectangle(
                (e.clientX - rect.left) * scaleX,
                CONFIG.BOX.SPAWN_OFFSET,
                CONFIG.BOX.SIZE,
                CONFIG.BOX.SIZE,
                {
                    ...CONFIG.BOX.PHYSICS,
                    label: 'box',
                    render: {
                        sprite: {
                            texture: 'boxX.png',
                            xScale: 1,
                            yScale: 1
                        }
                    }
                }
            );
            
            World.add(engine.world, box);
        });

        // Запуск систем
        Engine.run(engine);
        Render.run(render);
        updateParticles();

        function resize() {
            const canvas = render.canvas;
            const scale = Math.min(
                window.innerWidth / CONFIG.GAME_WIDTH,
                window.innerHeight / CONFIG.GAME_HEIGHT
            );
            
            canvas.style.transform = `scale(${scale})`;
            particlesCanvas.style.transform = `scale(${scale})`;
        }

        window.addEventListener('resize', resize);
        resize();
    </script>
</body>
</html>
